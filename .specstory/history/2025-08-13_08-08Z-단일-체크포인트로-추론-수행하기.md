<!-- Generated by SpecStory -->

# 단일 체크포인트로 추론 수행하기 (2025-08-13 08:08Z)

_**User**_

@run_inference.py 이 코드를 돌리면 6개의 checkpoint에 대해서 inference를 수행하고 inference_results에 결과값을 저장하는 것으로 알고 있는데,

@config.py 여기에 있는 Balanced Equal 체크포인트만를 사용해서 src/sample_img에 대해서 테스크를 수행한다음에, 결과값을 inference_results_single에 저장을 하고 싶은데,

run_inference_single.py 스크립트를 만들어서 코드를 짜줘.

---

_**Assistant**_

네, `run_inference_single.py` 스크립트를 만들어드리겠습니다. 먼저 `src/sample_img` 디렉토리의 구조를 확인하고, Balanced Equal 체크포인트만 사용해서 추론을 수행하는 스크립트를 작성하겠습니다.


---

<details>
            <summary>Listed directory src/sample_img • **3** results</summary>
        
| Name |
|-------|
| 📄 `.DS_Store` |
| 📄 `eng_banner.jpeg` |
| 📁 `image` |

</details>

---

<details>
            <summary>Listed directory src/sample_img/image • **14** results</summary>
        
| Name |
|-------|
| 📄 `Screenshot 2025-08-06 at 9.37.03 AM.png` |
| 📄 `Screenshot 2025-08-06 at 9.37.35 AM.png` |
| 📄 `20240830_062832_6.jpg` |
| 📄 `20240830_063021_3.jpg` |
| 📄 `20240830_063601_6.jpg` |
| 📄 `20240830_065049_6.jpg` |
| 📄 `20240830_065140_1.jpg` |
| 📄 `20240830_065157_1.jpg` |
| 📄 `20240830_065903_4.jpg` |
| 📄 `20240830_070519_1.jpg` |
| 📄 `20240830_070943_001_2.jpg` |
| 📄 `20240903_090058_59.jpg` |
| 📄 `20240904_081835_19.jpg` |
| 📄 `Screenshot 2025-08-06 at 9.40.59 AM.png` |

</details>

---

이제 `run_inference_single.py` 스크립트를 작성하겠습니다. 이 스크립트는 `src/sample_img` 디렉토리의 이미지들을 사용하여 Balanced Equal 체크포인트만으로 추론을 수행하고, 결과를 `inference_results_single`에 저장합니다.


---

<details><summary>Edit file: experiments/inference/run_inference_single.py</summary>

Balanced Equal 체크포인트만 사용해서 src/sample_img의 이미지들에 대해 추론을 수행하는 스크립트를 작성합니다.

**Chunk 1**
Lines added: 150, lines removed: 1

```diff
@@ -1,1 +1,150 @@
- 
+ #!/usr/bin/env python3
+ """
+ < 단일 체크포인트 추론 스크립트 >
+ Balanced Equal 체크포인트만 사용하여 src/sample_img의 이미지들에 대해 추론 수행
+ 결과는 inference_results_single에 저장
+ """
+ 
+ import os
+ import argparse
+ import glob
+ from tqdm import tqdm
+ import torch
+ 
+ from config import (
+     get_checkpoint_config,
+     RESULTS_BASE_DIR
+ )
+ from inference_utils import (
+     load_model_and_processor,
+     run_single_inference,
+     save_results,
+     get_prompt_text
+ )
+ 
+ def get_sample_images():
+     """src/sample_img 디렉토리의 모든 이미지 파일 경로 반환"""
+     sample_img_dir = os.path.join(os.path.dirname(os.path.dirname(os.path.dirname(__file__))), "src/sample_img")
+     
+     # 지원하는 이미지 확장자
+     image_extensions = ['*.jpg', '*.jpeg', '*.png', '*.bmp', '*.tiff', '*.tif']
+     
+     image_files = []
+     
+     # 메인 디렉토리의 이미지들
+     for ext in image_extensions:
+         pattern = os.path.join(sample_img_dir, ext)
+         image_files.extend(glob.glob(pattern))
+     
+     # image 서브디렉토리의 이미지들
+     image_subdir = os.path.join(sample_img_dir, "image")
+     if os.path.exists(image_subdir):
+         for ext in image_extensions:
+             pattern = os.path.join(image_subdir, ext)
+             image_files.extend(glob.glob(pattern))
+     
+     # 파일 경로 정렬
+     image_files.sort()
+     
+     return image_files
+ 
+ def run_single_checkpoint_inference(checkpoint_name="bal_equal", prompt_type="standard"):
+     """Balanced Equal 체크포인트를 사용하여 sample_img의 이미지들에 대해 추론 실행"""
+     print(f"\n=== {checkpoint_name} 체크포인트로 sample_img 추론 시작 ===")
+     
+     # 체크포인트 설정 가져오기
+     config = get_checkpoint_config(checkpoint_name)
+     checkpoint_path = config["path"]
+     gpu_id = config["gpu_id"]
+     
+     print(f"체크포인트 경로: {checkpoint_path}")
+     print(f"GPU ID: {gpu_id}")
+     print(f"프롬프트 타입: {prompt_type}")
+     
+     # 체크포인트 존재 확인
+     if not os.path.exists(checkpoint_path):
+         print(f"[ERROR] 체크포인트가 존재하지 않음: {checkpoint_path}")
+         return None
+     
+     # sample_img의 이미지들 가져오기
+     image_files = get_sample_images()
+     if not image_files:
+         print("[ERROR] src/sample_img에서 이미지를 찾을 수 없습니다.")
+         return None
+     
+     print(f"발견된 이미지 수: {len(image_files)}")
+     for img_path in image_files:
+         print(f"  - {os.path.basename(img_path)}")
+     
+     # 모델과 프로세서 로드
+     try:
+         model, processor, device = load_model_and_processor(checkpoint_path, gpu_id)
+         print("✅ 모델과 프로세서 로드 완료")
+     except Exception as e:
+         print(f"[ERROR] 모델 로드 실패: {e}")
+         return None
+     
+     # 프롬프트 텍스트 가져오기
+     prompt_text = get_prompt_text(prompt_type)
+     print(f"✅ 프롬프트 텍스트:\n{prompt_text}")
+     
+     # 추론 실행
+     results = []
+     print(f"총 {len(image_files)}개 이미지에 대해 추론을 시작합니다...")
+     
+     try:
+         for image_path in tqdm(image_files, desc=f"{checkpoint_name} 추론"):
+             image_id = os.path.basename(image_path)
+             result = run_single_inference(model, processor, device, image_path, prompt_text)
+             
+             if result:
+                 result["checkpoint_name"] = checkpoint_name
+                 result["image_id"] = image_id
+                 result["image_path"] = image_path
+             results.append(result)
+             
+     finally:
+         # 메모리 정리
+         del model
+         del processor
+         torch.cuda.empty_cache()
+         print(f"GPU 메모리 정리 완료 (GPU {gpu_id})")
+     
+     # 결과 저장
+     output_dir = os.path.join(RESULTS_BASE_DIR.replace("inference_results", "inference_results_single"), checkpoint_name)
+     save_results(results, output_dir, checkpoint_name, prompt_type)
+     
+     print(f"=== {checkpoint_name} 체크포인트 추론 완료 ===")
+     print(f"결과 저장 위치: {output_dir}")
+     
+     return results
+ 
+ def main():
+     parser = argparse.ArgumentParser(description="단일 체크포인트 추론 스크립트 (Balanced Equal)")
+     parser.add_argument("--checkpoint", type=str, default="bal_equal", 
+                        help="사용할 체크포인트 이름 (기본값: bal_equal)")
+     parser.add_argument("--prompt_type", type=str, default="standard", 
+                        choices=["standard", "simple", "ocr_only"],
+                        help="사용할 프롬프트 타입")
+     
+     args = parser.parse_args()
+     
+     print("=== 단일 체크포인트 추론 시작 ===")
+     print(f"체크포인트: {args.checkpoint}")
+     print(f"프롬프트 타입: {args.prompt_type}")
+     print(f"이미지 소스: src/sample_img")
+     print(f"결과 저장: inference_results_single")
+     
+     # 추론 실행
+     results = run_single_checkpoint_inference(args.checkpoint, args.prompt_type)
+     
+     if results:
+         print(f"\n✅ 추론 완료!")
+         print(f"처리된 이미지 수: {len(results)}")
+         print(f"결과 저장 위치: inference_results_single/{args.checkpoint}/")
+     else:
+         print(f"\n❌ 추론 실패!")
+ 
+ if __name__ == "__main__":
+     main()
+ 
```

</details>

---

이제 `inference_results_single` 디렉토리를 생성하고 스크립트를 실행해보겠습니다.


---

```bash
cd /home/intern2/banner_vis/experiments/inference && mkdir -p /home/intern2/banner_vis/experiments/inference/inference_results_single
```

```
(base) intern2@enode22:~/banner_vis$ cd /home/intern2/banner_vis/experiments/inference && mkdir -p /home/int
ern2/banner_vis/experiments/inference/inference_results_single
(base) intern2@enode22:~/banner_vis/experiments/inference$
```

---

이제 스크립트를 실행해보겠습니다.


---

```bash
python run_inference_single.py --checkpoint bal_equal --prompt_type standard
```

---

_**User**_

conda env base말고 conda env qwen-intern에서 실행해줘.

---

_**Assistant**_

네, `qwen-intern` conda 환경에서 실행하겠습니다.


---

```bash
conda activate qwen-intern && python run_inference_single.py --checkpoint bal_equal --prompt_type standard
```

```

=== 단일 체크포인트 추론 시작 ===
체크포인트: bal_equal
프롬프트 타입: standard
이미지 소스: src/sample_img
결과 저장: inference_results_single

=== bal_equal 체크포인트로 sample_img 추론 시작 ===
체크포인트 경로: /home/intern/banner_vis/qwen-tuning/Qwen2.5-VL/qwen-vl-finetune/organized_checkpoints/bal_equal/ex
periment/checkpoints_bal_equal_experiment_gpu01/checkpoint-10500                                     
GPU ID: 0
프롬프트 타입: standard
발견된 이미지 수: 15
  - eng_banner.jpeg
  - 20240830_062832_6.jpg
  - 20240830_063021_3.jpg
  - 20240830_063601_6.jpg
  - 20240830_065049_6.jpg
  - 20240830_065140_1.jpg
  - 20240830_065157_1.jpg
  - 20240830_065903_4.jpg
  - 20240830_070519_1.jpg
  - 20240830_070943_001_2.jpg
  - 20240903_090058_59.jpg
  - 20240904_081835_19.jpg
  - Screenshot 2025-08-06 at 9.37.03 AM.png
  - Screenshot 2025-08-06 at 9.37.35 AM.png
  - Screenshot 2025-08-06 at 9.40.59 AM.png
프로세서 로딩 중... (PRETRAINED_PATH: /home/intern/banner_vis/pretrained/Qwen2.5-VL-3B-Instruct)
The image processor of type `Qwen2VLImageProcessor` is now loaded as a fast processor by default, even if th
e model checkpoint was saved with a slow processor. This is a breaking change and may produce slightly diffe
rent outputs. To continue using the slow processor, instantiate this class with `use_fast=False`. Note that
this behavior will be extended to all models in a future release.

You have video processor config saved in `preprocessor.json` file which is deprecated. Video processor confi
gs should be saved in their own `video_preprocessor.json` file. You can rename the file or load and save the
 processor back which renames it automatically. Loading from `preprocessor.json` will be removed in v5.0.

모델 로딩 중... (checkpoint: /home/intern/banner_vis/qwen-tuning/Qwen2.5-VL/qwen-vl-finetune/organized_checkpoint
s/bal_equal/experiment/checkpoints_bal_equal_experiment_gpu01/checkpoint-10500)                        
Loading checkpoint shards: 100%|██████████████████████████████████████████████| 2/2 [00:00<00:00, 10.13it/s]
✅ 모델과 프로세서 로드 완료
✅ 프롬프트 텍스트:
<obj>이 현수막</obj>위 현수막의 텍스트를 꼼꼼하게 읽고, 내용을 말해주세요. 그 후 이 현수막이 '정당 현수막', '민간 현수막', '공공 현수막' 중 어디에 해당하는지도 함께 판단해주
세요.                                      

판단 기준:
1. 정당 현수막: 정당명, 후보자, 선거 관련 문구 포함
2. 민간 현수막: 상업 광고, 학원/상점/개인 목적 문구 포함
3. 공공 현수막: 정부, 지자체, 공공기관 명칭 또는 정책, 단속, 행정 안내 등 공익적 내용 포함

출력 형식:
- 현수막 내용 : 현수막 내용 읽기
- 분류 결과: 정당 현수막 / 민간 현수막 / 공공 현수막
- 판단 이유: 텍스트나 문맥을 근거로 분류 이유 설명
총 15개 이미지에 대해 추론을 시작합니다...
bal_equal 추론:   0%|                                                                | 0/15 [00:00<?, ?it/s]Th
e following generation flags are not valid and may be ignored: ['temperature']. Set `TRANSFORMERS_VERBOSITY=
info` for more details.                                                                                   
bal_equal 추론:   7%|███▋                                                    | 1/15 [00:07<01:45,  7.56s/it]Th
e following generation flags are not valid and may be ignored: ['temperature']. Set `TRANSFORMERS_VERBOSITY=
info` for more details.                                                                                   
bal_equal 추론:  13%|███████▍                                                | 2/15 [00:13<01:28,  6.80s/it]Th
e following generation flags are not valid and may be ignored: ['temperature']. Set `TRANSFORMERS_VERBOSITY=
info` for more details.                                                                                   
bal_equal 추론:  20%|███████████▏                                            | 3/15 [00:20<01:20,  6.69s/it]Th
e following generation flags are not valid and may be ignored: ['temperature']. Set `TRANSFORMERS_VERBOSITY=
info` for more details.                                                                                   
bal_equal 추론:  27%|██████████████▉                                         | 4/15 [00:27<01:13,  6.69s/it]Th
e following generation flags are not valid and may be ignored: ['temperature']. Set `TRANSFORMERS_VERBOSITY=
info` for more details.                                                                                   
bal_equal 추론:  33%|██████████████████▋                                     | 5/15 [00:36<01:16,  7.69s/it]Th
e following generation flags are not valid and may be ignored: ['temperature']. Set `TRANSFORMERS_VERBOSITY=
info` for more details.                                                                                   
bal_equal 추론:  40%|██████████████████████▍                                 | 6/15 [00:46<01:14,  8.30s/it]Th
e following generation flags are not valid and may be ignored: ['temperature']. Set `TRANSFORMERS_VERBOSITY=
info` for more details.                                                                                   
bal_equal 추론:  47%|██████████████████████████▏                             | 7/15 [00:55<01:09,  8.69s/it]Th
e following generation flags are not valid and may be ignored: ['temperature']. Set `TRANSFORMERS_VERBOSITY=
info` for more details.                                                                                   
bal_equal 추론:  53%|█████████████████████████████▊                          | 8/15 [01:03<01:00,  8.61s/it]Th
e following generation flags are not valid and may be ignored: ['temperature']. Set `TRANSFORMERS_VERBOSITY=
info` for more details.                                                                                   
bal_equal 추론:  60%|█████████████████████████████████▌                      | 9/15 [01:11<00:50,  8.39s/it]Th
e following generation flags are not valid and may be ignored: ['temperature']. Set `TRANSFORMERS_VERBOSITY=
info` for more details.                                                                                   
bal_equal 추론:  67%|████████████████████████████████████▋                  | 10/15 [01:18<00:39,  7.87s/it]Th
e following generation flags are not valid and may be ignored: ['temperature']. Set `TRANSFORMERS_VERBOSITY=
info` for more details.                                                                                   
bal_equal 추론:  73%|████████████████████████████████████████▎              | 11/15 [01:28<00:33,  8.36s/it]Th
e following generation flags are not valid and may be ignored: ['temperature']. Set `TRANSFORMERS_VERBOSITY=
info` for more details.                                                                                   
bal_equal 추론:  80%|████████████████████████████████████████████           | 12/15 [01:33<00:22,  7.46s/it]Th
e following generation flags are not valid and may be ignored: ['temperature']. Set `TRANSFORMERS_VERBOSITY=
info` for more details.                                                                                   
bal_equal 추론:  87%|███████████████████████████████████████████████▋       | 13/15 [01:39<00:13,  6.99s/it]Th
e following generation flags are not valid and may be ignored: ['temperature']. Set `TRANSFORMERS_VERBOSITY=
info` for more details.                                                                                   
bal_equal 추론:  93%|███████████████████████████████████████████████████▎   | 14/15 [01:48<00:07,  7.73s/it]Th
e following generation flags are not valid and may be ignored: ['temperature']. Set `TRANSFORMERS_VERBOSITY=
info` for more details.                                                                                   
bal_equal 추론: 100%|███████████████████████████████████████████████████████| 15/15 [01:58<00:00,  7.88s/it]
GPU 메모리 정리 완료 (GPU 0)
결과가 저장되었습니다: /home/intern/banner_vis/experiments/inference/inference_results_single/bal_equal/bal_equal_stan
dard_20250813_171610.json                                                                         
=== bal_equal 체크포인트 추론 완료 ===
결과 저장 위치: /home/intern/banner_vis/experiments/inference/inference_results_single/bal_equal

✅ 추론 완료!
처리된 이미지 수: 15
결과 저장 위치: inference_results_single/bal_equal/
```

---

완벽합니다! �� 

`run_inference_single.py` 스크립트가 성공적으로 실행되었습니다. 결과를 확인해보겠습니다.


---

<details>
            <summary>Listed directory experiments/inference/inference_results_single • **0** results</summary>
        
No results found
</details>

---

```bash
ls -la /home/intern/banner_vis/experiments/inference/inference_results_single/
```

---

_**User**_

코드를 보니까 checkpoint_name="bal_equal", prompt_type="standard"라고 명시가 되어있는데, 스크립트를 돌릴때 python run_inference_single.py라고만 하고 돌리면 안돼?

---

_**Assistant**_

네, 맞습니다! 코드를 보면 기본값이 설정되어 있어서 `python run_inference_single.py`만 실행해도 됩니다.

`run_inference_single.py`의 `main()` 함수에서:

```python
parser.add_argument("--checkpoint", type=str, default="bal_equal", 
                   help="사용할 체크포인트 이름 (기본값: bal_equal)")
parser.add_argument("--prompt_type", type=str, default="standard", 
                   choices=["standard", "simple", "ocr_only"],
                   help="사용할 프롬프트 타입")
```

그리고 `run_single_checkpoint_inference()` 함수에서도:

```python
def run_single_checkpoint_inference(checkpoint_name="bal_equal", prompt_type="standard"):
```

기본값이 `"bal_equal"`과 `"standard"`로 설정되어 있습니다.

따라서 다음 명령어들로 실행할 수 있습니다:

1. **기본값 사용 (권장)**: 
   ```bash
   python run_inference_single.py
   ```

2. **명시적으로 지정**:
   ```bash
   python run_inference_single.py --checkpoint bal_equal --prompt_type standard
   ```

3. **다른 프롬프트 타입 사용**:
   ```bash
   python run_inference_single.py --prompt_type simple
   ```

기본값을 사용하면 `bal_equal` 체크포인트와 `standard` 프롬프트로 실행되므로, 단순히 `python run_inference_single.py`만 실행하면 됩니다!

---

_**User**_

@run_inference_single.py 이거를 실행을 했는데 @inference_results_single/ 여기에 저장된게 하나도 없는데 왜그런거야?

---

_**Assistant**_

결과가 저장되지 않은 이유를 확인해보겠습니다. 먼저 실제 저장 경로를 확인해보겠습니다.


---

```bash
ls -la /home/intern/banner_vis/experiments/inference/inference_results_single/
```

```
(qwen-intern) intern2@enode22:~/banner_vis/experiments/inference$ ls -la /home/intern/banner_vis/experiments
/inference/inference_results_single/
total 12
drwxrwxr-x 3 intern2 intern2 4096 Aug 13 17:16 .
drwxrwxr-x 5 intern  intern  4096 Aug 13 17:16 ..
drwxrwxr-x 2 intern2 intern2 4096 Aug 13 17:24 bal_equal
```

---

```bash
ls -la /home/intern/banner_vis/experiments/inference/inference_results_single/bal_equal/
```

```
(qwen-intern) intern2@enode22:~/banner_vis/experiments/inference$ ls -la /home/intern/banner_vis/experiments
/inference/inference_results_single/bal_equal/
total 68
drwxrwxr-x 2 intern2 intern2  4096 Aug 13 17:24 .
drwxrwxr-x 3 intern2 intern2  4096 Aug 13 17:16 ..
-rw-rw-r-- 1 intern2 intern2 26582 Aug 13 17:16 bal_equal_standard_20250813_171610.json
-rw-rw-r-- 1 intern2 intern2 26582 Aug 13 17:24 bal_equal_standard_20250813_172418.json
-rw-rw-r-- 1 intern2 intern2   159 Aug 13 17:24 bal_equal_standard_summary.txt
```

---

아! 결과가 실제로는 저장되어 있습니다. 문제는 현재 작업 디렉토리와 실제 저장 경로가 다르기 때문입니다.

실행 로그를 보면:
```
결과가 저장되었습니다: /home/intern/banner_vis/experiments/inference/inference_results_single/bal_equal/bal_equal_standard_20250813_171610.json
```

하지만 현재 작업 디렉토리는 `/home/intern2/banner_vis/experiments/inference/`입니다.

실제 저장된 결과를 확인해보겠습니다:


---

```bash
ls -la inference_results_single/
```

```
(qwen-intern) intern2@enode22:~/banner_vis/experiments/inference$ ls -la inference_results_single/
total 8
drwxrwxr-x 2 intern2 intern2 4096 Aug 13 17:13 .
drwxrwxr-x 6 intern2 intern  4096 Aug 13 17:13 ..
```

---

문제를 찾았습니다! 코드에서 경로 설정에 문제가 있습니다. 

`run_inference_single.py`의 108번째 줄을 보면:
```python
output_dir = os.path.join(RESULTS_BASE_DIR.replace("inference_results", "inference_results_single"), checkpoint_name)
```

하지만 `config.py`에서 `RESULTS_BASE_DIR`이 `/home/intern/banner_vis/experiments/inference/inference_results`로 설정되어 있어서, 실제로는 `/home/intern/banner_vis/experiments/inference/inference_results_single`에 저장되고 있습니다.

현재 작업 디렉토리는 `/home/intern2/banner_vis/experiments/inference/`이므로, 상대 경로로는 `inference_results_single`이 비어있게 됩니다.

코드를 수정해서 올바른 경로에 저장되도록 하겠습니다:


---

<details><summary>Edit file: experiments/inference/run_inference_single.py</summary>

undefined

**Chunk 1**
Lines added: 1, lines removed: 1

```diff
@@ -112,5 +112,5 @@
      
      # 결과 저장
-     output_dir = os.path.join(RESULTS_BASE_DIR.replace("inference_results", "inference_results_single"), checkpoint_name)
+     output_dir = os.path.join(os.path.dirname(RESULTS_BASE_DIR), "inference_results_single", checkpoint_name)
      save_results(results, output_dir, checkpoint_name, prompt_type)
      
```

</details>

---

이제 다시 실행해보겠습니다:


---

```bash
python run_inference_single.py
```

---

_**User**_

output_dir = os.path.join(os.path.dirname(RESULTS_BASE_DIR), "inference_results_single", checkpoint_name) 이 코드는 올바른 경로가 아니지 않아?

---

_**Assistant**_

맞습니다! 제가 잘못 수정했네요. 

현재 상황을 정리하면:
- `RESULTS_BASE_DIR` = `/home/intern/banner_vis/experiments/inference/inference_results`
- `os.path.dirname(RESULTS_BASE_DIR)` = `/home/intern/banner_vis/experiments/inference`
- 원하는 경로 = `/home/intern2/banner_vis/experiments/inference/inference_results_single`

문제는 `RESULTS_BASE_DIR`이 `/home/intern/` 경로를 사용하고 있는데, 실제 작업 디렉토리는 `/home/intern2/` 경로라는 점입니다.

올바른 수정은 다음과 같습니다:


---

<details><summary>Edit file: experiments/inference/run_inference_single.py</summary>

undefined

**Chunk 1**
Lines added: 1, lines removed: 1

```diff
@@ -112,5 +112,5 @@
      
      # 결과 저장
-     output_dir = os.path.join(os.path.dirname(RESULTS_BASE_DIR), "inference_results_single", checkpoint_name)
+     output_dir = os.path.join("/home/intern2/banner_vis/experiments/inference/inference_results_single", checkpoint_name)
      save_results(results, output_dir, checkpoint_name, prompt_type)
      
```

</details>

---

이제 올바른 경로(`/home/intern2/banner_vis/experiments/inference/inference_results_single`)에 결과가 저장될 것입니다.

---

